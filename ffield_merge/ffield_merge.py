#!/usr/bin/env python
# -*- coding: utf8 -*-
'''
ffield_merge.py
-----------------
Merges two torsions part of a ffield file.

$Id: reax_molfra.py 128 2008-09-23 11:02:20Z mikexstudios $
'''
__author__ = 'Michael Huynh (mikeh@caltech.edu)'
__website__ = 'http://www.mikexstudios.com'
__copyright__ = 'General Public License (GPL)'

import sys #For arguments and exit (in older python versions)
import os #For file exist check and splitext and path stuff
import re
import time #for sleep

base_text = '''
  1  1  1  1  -0.2500  34.7453   0.0288  -6.3507  -1.6000   0.0000   0.0000     
  1  1  1  2  -0.2500  29.2131   0.2945  -4.9581  -2.1802   0.0000   0.0000     
  2  1  1  2  -0.2500  31.2081   0.4539  -4.8923  -2.2677   0.0000   0.0000     
  1  1  1  3   1.2799  20.7787  -0.5249  -2.5000  -1.0000   0.0000   0.0000     
  2  1  1  3   1.9159  19.8113   0.7914  -4.6995  -1.0000   0.0000   0.0000     
  3  1  1  3  -1.4477  16.6853   0.6461  -4.9622  -1.0000   0.0000   0.0000     
  1  1  3  1   0.4816  19.6316  -0.0057  -2.5000  -1.0000   0.0000   0.0000     
  1  1  3  2   1.2044  80.0000  -0.3139  -6.1481  -1.0000   0.0000   0.0000     
  2  1  3  1  -2.5000  31.0191   0.6165  -2.7733  -2.9807   0.0000   0.0000     
  2  1  3  2  -2.4875  70.8145   0.7582  -4.2274  -3.0000   0.0000   0.0000     
  1  1  3  3  -0.3566  10.0000   0.0816  -2.6110  -1.9631   0.0000   0.0000     
  2  1  3  3  -1.4383  80.0000   1.0000  -3.6877  -2.8000   0.0000   0.0000     
  3  1  3  1  -1.1390  78.0747  -0.0964  -4.5172  -3.0000   0.0000   0.0000     
  3  1  3  2  -2.5000  70.3345  -1.0000  -5.5315  -3.0000   0.0000   0.0000     
  3  1  3  3  -2.0234  80.0000   0.1684  -3.1568  -2.6174   0.0000   0.0000     
  1  3  3  1   1.1637 -17.3637   0.5459  -3.6005  -2.6938   0.0000   0.0000     
  1  3  3  2  -2.1289  12.8382   1.0000  -5.6657  -2.9759   0.0000   0.0000     
  2  3  3  2   2.5000 -22.9397   0.6991  -3.3961  -1.0000   0.0000   0.0000     
  1  3  3  3   2.5000 -25.0000   1.0000  -2.5000  -1.0000   0.0000   0.0000     
  2  3  3  3  -2.5000  -2.5103  -1.0000  -2.5000  -1.0000   0.0000   0.0000     
  3  3  3  3  -2.5000 -25.0000   1.0000  -2.5000  -1.0000   0.0000   0.0000     
  0  1  2  0   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000     
  0  2  2  0   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000     
  0  2  3  0   0.0000   0.1000   0.0200  -2.5415   0.0000   0.0000   0.0000     
  0  1  1  0   0.0000  50.0000   0.3000  -4.0000  -2.0000   0.0000   0.0000     
  0  3  3  0   0.5511  25.4150   1.1330  -5.1903  -1.0000   0.0000   0.0000     
  0  1  4  0   1.7932 141.5515   0.9686  -4.2368  -1.9727   0.0000   0.0000     
  0  2  4  0  -1.5000   0.1032   0.0100  -5.0965   0.0000   0.0000   0.0000     
  0  3  4  0   1.1397  61.3225   0.5139  -3.8507  -3.0000   0.0000   0.0000     
  0  4  4  0   0.7265  44.3155   1.0000  -4.4046  -2.0000   0.0000   0.0000     
  4  1  4  4  -0.0949   8.7582   0.3310  -7.9430  -2.0000   0.0000   0.0000     
  0  1  5  0   3.3423  30.3435   0.0365  -2.7171   0.0000   0.0000   0.0000     
  0  5  5  0  -0.0555  -5.0000   0.1515  -2.2056   0.0000   0.0000   0.0000     
  0  2  5  0   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000     
  2  3  5  3   2.5000   2.5000   0.2237 -10.0000  -1.0000   0.0000   0.0000     
  0  3  5  0  -2.5000  50.0000  -0.5000 -10.0000  -1.0000   0.0000   0.0000     
  0  6  6  0   0.0000   0.0000   0.1200  -2.4426   0.0000   0.0000   0.0000     
  0  2  6  0   0.0000   0.0000   0.1200  -2.4847   0.0000   0.0000   0.0000     
  0  3  6  0   0.0000   0.0000   0.1200  -2.4703   0.0000   0.0000   0.0000     
  1  1  3  3  -0.0002  20.1851   0.1601  -9.0000  -2.0000   0.0000   0.0000     
  1  3  3  1   0.0002  80.0000  -1.5000  -4.4848  -2.0000   0.0000   0.0000     
  3  1  3  3  -0.1583  20.0000   1.5000  -9.0000  -2.0000   0.0000   0.0000     
  1  1  1  7  -0.3232  14.3871   0.1823  -9.8682  -1.7255   0.0000   0.0000     
  7  1  1  7  -0.1452  50.0000  -0.1915  -8.0773  -1.7255   0.0000   0.0000     
  0  1  7  0   4.0000  45.8264   0.9000  -4.0000   0.0000   0.0000   0.0000     
  0  7  7  0   4.0000  45.8264   0.9000  -4.0000   0.0000   0.0000   0.0000     
  2  1  3  7  -1.5000  18.9285   0.3649  -6.1208   0.0000   0.0000   0.0000     
  2  3  7  3   1.5000  -1.0000   0.2575  -6.2100   0.0000   0.0000   0.0000     
  1  3  7  3  -1.4375  -0.8700   0.9861  -2.5424   0.0000   0.0000   0.0000     
  7  3  7  3  -1.5000  21.5086  -1.0000  -4.8869   0.0000   0.0000   0.0000     
  2  1  3  9   0.0000  84.3556   0.1000  -3.1953   0.0000   0.0000   0.0000     
  1  1  3  9   0.0000  51.0461   0.1059  -7.2043   0.0000   0.0000   0.0000     
  2  3  9  3   0.0000  14.7459   0.1000  -3.0965   0.0000   0.0000   0.0000     
  1  1  1 11   0.5000   0.1000   0.4683 -11.5274  -1.7255   0.0000   0.0000     
  2  1  1 11   0.0000  49.3871   0.2000 -10.5765  -1.7255   0.0000   0.0000     
 11  1  1 11  -0.5000  95.4727  -0.2080  -4.8579  -1.7255   0.0000   0.0000     
  0  1 11  0   4.0000  45.8264   0.9000  -4.0000   0.0000   0.0000   0.0000     
  0 11 11  0   4.0000  45.8264   0.9000  -4.0000   0.0000   0.0000   0.0000     
'''

override_text = '''
  1  1  1  1  -0.2500  34.7453   0.0288  -6.3507  -1.6000   0.0000   0.0000     
  1  1  1  2  -0.2500  29.2131   0.2945  -4.9581  -2.1802   0.0000   0.0000     
  2  1  1  2  -0.2500  31.2081   0.4539  -4.8923  -2.2677   0.0000   0.0000     
  0  1  2  0   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000     
  0  2  2  0   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000     
  0  1  3  0   0.0064  92.1459   0.9925  -3.0659  -2.1565   0.0000   0.0000     
  0  2  3  0   0.0000   0.1000   0.0200  -2.5415   0.0000   0.0000   0.0000     
  0  3  3  0   0.5511  25.4150   1.1330  -5.1903  -1.0000   0.0000   0.0000     
  0  1  4  0  -2.4242 128.1636   0.3739  -6.6098  -2.0000   0.0000   0.0000     
  0  2  4  0   0.0000   0.1000   0.0200  -2.5415   0.0000   0.0000   0.0000     
  0  3  4  0   1.4816  55.6641   0.0004  -7.0465  -2.0000   0.0000   0.0000     
  0  4  4  0  -0.3244  27.7086   0.0039  -2.8272  -2.0000   0.0000   0.0000     
  0  1  1  0   0.0000   0.6675   0.0000  -8.2352   0.0000   0.0000   0.0000     
  4  1  4  4  -5.5181   8.9706   0.0004  -6.1782  -2.0000   0.0000   0.0000     
  0  1  5  0   3.3423  30.3435   0.0365  -2.7171   0.0000   0.0000   0.0000     
  0  5  5  0  -0.0555 -42.7738   0.1515  -2.2056   0.0000   0.0000   0.0000     
  0  2  5  0   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000   0.0000     
  0  6  6  0   0.0000   0.0000   0.1200  -2.4426   0.0000   0.0000   0.0000     
  0  2  6  0   0.0000   0.0000   0.1200  -2.4847   0.0000   0.0000   0.0000     
  0  3  6  0   0.0000   0.0000   0.1200  -2.4703   0.0000   0.0000   0.0000     
  1  3  3  1   3.0311  96.8000   0.6062  -4.3299  -2.0536   0.0000   0.0000     
  1  1  3  1   0.0588 100.0000   0.0161  -2.5000  -1.0000   0.0000   0.0000     
  2  1  3  1   4.0000  25.0000   0.8942  -9.0000  -1.1657   0.0000   0.0000     
  1  1  3  2   4.0000 100.0000   2.0000  -2.5000  -1.0000   0.0000   0.0000     
  2  1  3  2   2.4070 100.0000   1.5438  -5.3254  -2.7319   0.0000   0.0000     
  2  1  3 14   1.6297  56.8132   0.3398  -2.6912  -2.1000   0.0000   0.0000     
  1  1  3 14  -0.0427  13.4096   0.9351  -6.5245  -2.1000   0.0000   0.0000     
  2  3 14  3   2.5000  11.6208   1.0000  -9.0000  -1.0000   0.0000   0.0000     
  2  1  3 12  -0.2500  45.7639   0.3000  -3.5745  -2.1565   0.0000   0.0000     
  1  1  3 12  -0.2500  69.1094   0.3000  -3.0983  -2.1565   0.0000   0.0000     
  2  3 12  3  -0.4306   7.5000  -0.5000  -6.9948  -1.0000   0.0000   0.0000     
  2  1  3 13  -0.0131  90.0000   0.1642  -3.8725  -2.1565   0.0000   0.0000     
  1  1  3 13   0.1646  87.8037   0.1000  -3.1250  -2.1565   0.0000   0.0000     
  2  3 13  3   2.5000   1.0000   0.7530  -9.0000  -1.0000   0.0000   0.0000     
'''

def main():
    #Parse text into dict-line
    base_dict = text_to_dict(base_text.splitlines())
    #print str(len(base_dict))
    override_dict = text_to_dict(override_text.splitlines())

    #Merge dicts
    merged_dict = merge_dicts(base_dict, override_dict)

    #Now print out all lines:
    for k, v in merged_dict.iteritems():
        print v
    
    print 'Total entries: '+str(len(merged_dict))


def text_to_dict(text):
    dict = {}
    for line in text:
        line_elements = line.split() #splits by space
        if len(line_elements) > 1:
            #Combine first four to make key
            k = ''.join(line_elements[0:4])
            if k in dict:
                print 'ERROR: '+k+' already exists!'
            dict[k] = line
            #print dict[k]
        #else:
        #    print 'ERROR: '+line

    return dict

def merge_dicts(base, override):
    #We put restrictions for only CHONS atoms:
    #1. Must contain only 0, 1,2,3,4,5 digits
    #2. Max length of 4 (so that we don't have any double digit stuff)
    allowed_digits = (0, 1, 2, 3, 4, 5)

    for k, v in override.iteritems():
        if len(k) > 4:
            print 'ERROR: len gt 4 -> '+k
            continue
        for digit in k:
            digit = int(digit)
            if digit in allowed_digits:
                pass #Do nothing
            else:
                print 'ERROR: bad digit -> '+k
                continue
        base[k] = v

    return base

def tests():

    print 'All tests completed successfully!'
    sys.exit(0)


if __name__ == '__main__':
    #tests()
    main()
